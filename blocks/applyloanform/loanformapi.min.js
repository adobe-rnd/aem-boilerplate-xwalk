import{errorPopUp as T,formInteraction as q,generateLead as R,lpOtpValidate as j,resendOtp as C,thankYouPopUp as x,verifyOtp as J}from"../../dl.min.js";import{fetchAPI as l,targetObject as c}from"../../scripts/scripts.min.js";import{accessTokenURL as N,generateOTPURL as E,leadAPIURL as B,otpTokenURL as U,resendOTPUrl as _,smsURL as F,verifyOTPURL as z}from"./loanformapiurls.min.js";import{cutomerEmployment as D,cutomerNo as V,loanFromBtn as L,loanOtpInput as $,loanProduct as P}from"./loanformdom.min.js";import{ProductLogics as H}from"./loanformlogic.min.js";let p="Rejected",i,m,f,w,I,A,b,v,h,y;export function buttonCLick(){L().addEventListener("click",({currentTarget:e})=>{e.closest(".loan-form-button-container").classList.add("loader-initialized"),$().value="",workFlow();try{g(),q(i,"Form Submit",c.pageName),R(m,i,f,h,y,c.pageName)}catch(t){console.warn(t)}})}export function getAccessToken(){return new Promise(e=>{Y(sessionStorage.getItem("tokenexpiretime"))?AccessTokenAPI().then(t=>{const n=O(t);sessionStorage.setItem("accesstoken",n.responseJson.accesstoken),sessionStorage.setItem("tokenexpiretime",n.responseJson.tokenexpiretime),e(n.responseJson.accesstoken)}):e(sessionStorage.getItem("accesstoken"))})}export function AccessTokenAPI(){const e={requestJson:{client_id:"270762d6d2544ce695908b3496d25e06",client_secret:"5c2e50eedd8f484387ad432be9897ce4",source:"WebApp"}};return new Promise(async(t,n)=>{try{const o=await l("POST",N,e);t(o)}catch(o){n(o),showNetworkFailedScreen(o)}})}export function generateOTPAPI(e,t,n,o){const r={requestJson:{mobileno:t,source:o,productName:n},headerJson:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}};return new Promise((s,d)=>{l("POST",E,r).then((a,u)=>{const S=O(a),k=S.responseJson.authUniqueId;sessionStorage.setItem("otpAuthId",k),s(S.responseJson)}).catch(a=>{console.warn(a),showNetworkFailedScreen(a)})})}function re(e){const t={requestJson:"client_id=gx7vVKKAcOCGIpWc6O7kBYRo209OAHhq&client_secret=L3pARR8QWmanaNVC&grant_type=client_credentials"};return new Promise((n,o)=>{const r="client_id=gx7vVKKAcOCGIpWc6O7kBYRo209OAHhq&client_secret=L3pARR8QWmanaNVC&grant_type=client_credentials",s=new XMLHttpRequest;s.withCredentials=!0,s.addEventListener("readystatechange",function(){this.readyState===4&&(this.status>=200&&this.status<300?n(JSON.parse(this.responseText)):o(new Error(`Request failed with status ${this.status}`)))}),s.open("POST",U),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("Cookie","CookieConsentPolicy=0:1; LSKey-c$CookieConsentPolicy=0:1"),s.send(r)})}function se(e){const t={requestJson:{},headerJson:{Authorization:`Bearer ${e}`}};return new Promise((n,o)=>{l("POST",F,t).then(r=>{const s=O(r);n(s.responseJson.access_token)}).catch(r=>{console.warn(r),showNetworkFailedScreen(r)})})}function K(e,t){const n={requestJson:W(p,t),headerJson:{Authorization:`Bearer ${e}`}};return new Promise((o,r)=>{l("POST",B,n).then(s=>{o("Data inserted successfully.")})})}export function verfyOtpAPI(e){const t={requestJson:{authUniqueId:sessionStorage.getItem("otpAuthId"),source:"External",otp:e},headerJson:{Authorization:`Bearer ${sessionStorage.getItem("accesstoken")}`}};return new Promise((n,o)=>{l("POST",z,t).then(r=>{n(r.responseJson)}).catch(r=>{showNetworkFailedScreen(r)})})}export function resendOtpAPI(e){const t={requestJson:{authUniqueId:sessionStorage.getItem("otpAuthId"),source:e},headerJson:{Authorization:`Bearer ${sessionStorage.getItem("accesstoken")}`}};return new Promise((n,o)=>{l("POST",_,t).then(r=>{n(r)}).catch(r=>{showNetworkFailedScreen(r)})})}export function workFlow(){getAccessToken().then(e=>generateOTPAPI(e,V().value,P().dataset.loanName,"Leadform")).then(()=>{M(),X()}).catch(e=>{console.warn(e,e.message),showNetworkFailedScreen(e)}).finally(()=>{L().closest(".loan-form-button-container").classList.remove("loader-initialized")})}function g(){i=document.querySelector("#form-loan-type")?.value,m=document.querySelector(".loan-form-heading-parent").innerText,f=document.querySelector("#form-loan-amount")?.value,w=document.querySelector("#form-customer-name")?.value,I=document.querySelector("#form-customer-no")?.value,A=document.querySelector("[name=emplyoment]:checked").id=="radio-salary"?"Salaried":"Business",b=document.querySelector("#form-income")?.value,v=document.querySelector("#loan-form-dob")?.value,h=document.querySelector("#form-state")?.value,y=document.querySelector("#form-branch-city")?.value}function W(e,t){return g(),{LeadData:{Name:w,MobileNumber:I,Occupation:A,LoanProduct:i,MonthlyIncome:b,LoanAmount:f,DateOfBirth:v,State:h,Branch:y,RejectStatus:e,AuthUniqueId:t}}}function O(e){return typeof e=="string"?JSON.parse(e):e}function M(){const e=document.querySelector("#loan-from-otp-verify");e.dataset.isEvent||(e.addEventListener("click",t=>{g();const n=document.querySelector("#loan-form-otp-input").value;e.closest(".loan-form-button-container").classList.add("loader-initialized"),q(i,"verify",c.pageName);try{const o=t.target.textContent.trim()||"";j(o,i,c.pageName)}catch(o){console.warn(o)}n&&verfyOtpAPI(n).then(({returnResponse:o,authUniqueId:r})=>{const{statusCode:s}=o;J(t.target.innerText,c.pageName,"");const d=document.querySelector(".wrongotpmessage");if(s!=100){d.style.display="block";return}d.style.display="none";const a=document.querySelector(".loan-form-sub-parent");if(H(G())){a.classList.add("loan-form-success"),p="Approved";try{x(m,i,c.pageName)}catch(u){console.warn(u)}}else{a.classList.add("loan-form-request-fail"),p="Rejected";try{T(m,i,a.querySelector(".redbox")?.innerText,c.pageName)}catch(u){console.warn(u)}}K(sessionStorage.getItem("accesstoken"),r).catch(u=>{console.warn(u),showNetworkFailedScreen(u)})}).catch(o=>{console.warn(`verifyOtpErr: ${o}`),showNetworkFailedScreen(o)}).finally(()=>{e.closest(".loan-form-button-container").classList.remove("loader-initialized")})}),e.dataset.isEvent=!0)}function X(){const e=document.querySelector("#loan-form-resend-otp");e.dataset.isEvent||(e.addEventListener("click",t=>{try{C(t.target.innerText,c.pageName)}catch(n){console.warn(n)}resendOtpAPI("Leadform").then(({responseJson:n})=>{const o=n.authUniqueId;sessionStorage.setItem("otpAuthId",o)}).catch(n=>{console.warn(`resendOtpErr: ${n}`),showNetworkFailedScreen(n)})}),e.dataset.isEvent=!0)}function Y(e){if(!e||e=="undefined")return!0;const t=new Date;return new Date(e)<t}function G(){const e=P().dataset.loanType,t=D().id=="radio-salary"?"salaried":"business";return Q(e,t)}function Q(e,t){return e=="hl"||e=="msme"?t=="salaried"?"otherLoanSAL":"otherLoanSE":e=="ubl"?t=="business"?"bussinessLoan":!1:e=="pl"?t=="salaried"?"personalLoan":!1:e=="ucl"?t=="salaried"?"preOwnedCarLoanSAL":"preOwnedCarLoanSE":!1}export function showNetworkFailedScreen(e){if(e.code=="ERR_NETWORK"){document.querySelector(".loan-form-sub-parent").classList.add("loan-form-something-wrong");const n=document.querySelector(".failedContainer");otpPopupFailureFun(n)}}

import{fetchAPI as y}from"../../scripts/common.min.js";import{generateOTPAPI as S,getAccessToken as f,resendOtpAPI as k,showNetworkFailedScreen as i,verfyOtpAPI as L}from"../applyloanform/loanformapi.min.js";import{getWhatAPIAuthURL as I,getWhatAPIURL as C}from"../applyloanform/loanformapiurls.min.js";const q=30;let g,m,a;const T=0,d={atWhichStage:""};export function otpPopupCall(e){const o=e.closest(".section");d.atWhichStage="generateOtp";const t=document.createElement("div"),r=o.querySelector(".input-field .desktopButton button"),s=o.querySelector(".input-field input"),c=document.querySelector(".failureTryAgain")||t;r.addEventListener("click",n=>{a=s.value,document.querySelector(".pageLoaderText").innerText=`Sending OTP to mobile number ${a}`,p(),h(),f().then(l=>{S(l,a,"Whatsapp","Whatsapp").then(u=>{u.returnResponse.statusCode==100&&removeLoader()})})}),c.addEventListener("click",n=>{if(n.stopPropagation(),a=s.value,document.querySelector(".pageLoaderText").innerText=`Sending OTP to mobile number ${a}`,p(),d.atWhichStage=="generateOtp")h(),f().then(l=>{S(l,a,"Whatsapp","Whatsapp").then(u=>{u.returnResponse.statusCode==100?(removeLoader(),document.querySelector(".failedContainer").style.display="none",sessionStorage.removeItem("count")):(removeLoader(),sessionStorage.getItem("count"),sessionStorage.getItem("count")<=5?(document.querySelector(".modal-overlay").classList.add("overlay"),document.querySelector(".modal-overlay").classList.remove("dp-none"),document.querySelector(".otppopup").style.display="block",document.querySelector(".loan-form-heading-parent").style.display="none",document.querySelector(".loan-form-otp").style.display="none",document.querySelector(".successContainer").style.display="none",document.querySelector(".failedContainer").style.display="block",document.querySelector(".loan-form-otp-button-container").style.display="none",removeLoader(),sessionStorage.setItem("count",T+1)):(document.querySelector(".tryAgainBtnText").style.display="none",sessionStorage.removeItem("count")))})});else if(d.atWhichStage=="verifyOtp"){const l=document.querySelector("#loan-form-otp-input").value;b(l)}}),(document.querySelector("#loan-form-resend-otp")||t).addEventListener("click",()=>{p(),v(q,g),k("Whatsapp").then(({responseJson:n})=>{const l=n.authUniqueId;sessionStorage.setItem("otpAuthId",l),removeLoader()}).catch(n=>{console.warn(`resendOtpErr: ${n}`),i(n)})}),(document.querySelector("#otp-change-num")||t).addEventListener("click",()=>{close()}),(document.querySelector(".loan-form-otp-parent .leftarrow")||t).addEventListener("click",()=>{close()}),(document.querySelector("#loan-form-otp-input")||t).addEventListener("input",n=>{document.querySelector(".changeableDigit").innerText=n.target.value.length,n.target.value.length==4?(document.querySelector("#loan-from-otp-verify").style.pointerEvents="unset",document.querySelector("#loan-from-otp-verify").style.background="#F26841"):(document.querySelector("#loan-from-otp-verify").style.pointerEvents="none",document.querySelector("#loan-from-otp-verify").style.background="#FAC3B3"),isNaN(n.target.value)&&(n.target.value=n.target.value.replace(/\D/g,""))}),(document.querySelector("#loan-form-otp-input")||t).addEventListener("keyup",n=>{const{target:l}=n,u=n.key.toLowerCase();(u=="backspace"||u=="delete")&&l.value===""&&(document.querySelector(".changeableDigit").innerText=0)}),(document.querySelector("#loan-from-otp-verify")||t).addEventListener("click",()=>{const n=document.querySelector("#loan-form-otp-input").value;d.atWhichStage="verifyOtp",p(),b(n)}),(document.querySelector(".closeImg")||t).addEventListener("click",()=>{sucessPopupCloe()}),(document.querySelector(".failedContainer img")||t).addEventListener("click",()=>{failedPopupClose()})}export function otpPopupFailureFun(e){if(e){if(document.querySelector(".modal-overlay").classList.add("overlay"),document.querySelector(".modal-overlay").classList.remove("dp-none"),document.querySelector(".otppopup").style.display="block",document.querySelector(".loan-form-heading-parent").style.display="none",document.querySelector(".loan-form-otp").style.display="none",document.querySelector(".successContainer").style.display="none",document.querySelector(".failedContainer").style.display="block",document.querySelector(".loan-form-otp-button-container").style.display="none",removeLoader(),sessionStorage.getItem("count")){const o=parseInt(sessionStorage.getItem("count"));sessionStorage.setItem("count",o+1)}else sessionStorage.setItem("count",1);sessionStorage.getItem("count")>5&&(document.querySelector(".failureTryAgain").style.display="none",sessionStorage.removeItem("count"))}}function v(e,o){clearInterval(o),clearInterval(m);const t=document.querySelector("#loan-form-resend-otp");m=setInterval(()=>{e>=0?(document.querySelector(".applyloanform .timer").style.display="block",e<=9?document.querySelector(".applyloanform .timer").innerHTML=`00:0${e}`:document.querySelector(".applyloanform .timer").innerHTML=`00:${e}`,e--,t.style.pointerEvents="none"):(clearInterval(o),document.querySelector(".applyloanform .timer").style.display="none",t.style.pointerEvents="unset")},1e3)}export function removeLoader(){document.querySelector(".pageloader").classList.add("loader-disppear"),document.querySelector(".loan-form-otp-button-container").classList.remove("filterBlur"),document.querySelector(".loan-form.loan-form-sub-otp").classList.remove("filterBlur"),document.querySelector(".pageLoaderText").innerText=""}export function close(){const e=document.querySelector(".otppopup");e.style.display="none",clearInterval(m),document.querySelector(".modal-overlay").classList.remove("overlay"),document.querySelector(".modal-overlay").classList.add("dp-none"),document.querySelector("#loan-form-otp-input").value="",document.querySelector(".wrongotpmessage").style.display="none",document.querySelector(".wrongotpmessage").textContent=""}export function failedPopupClose(){document.querySelector(".modal-overlay").classList.remove("overlay"),document.querySelector(".modal-overlay").classList.add("dp-none"),document.querySelector(".otppopup").style.display="none",document.querySelector(".loan-form-heading-parent").style.display="block",document.querySelector(".loan-form-otp").style.display="block",document.querySelector(".successContainer").style.display="none",document.querySelector(".failedContainer").style.display="none",document.querySelector(".loan-form-otp-button-container").style.display="block"}function h(){document.querySelector(".otppopup").style.display="block",document.querySelector(".modal-overlay").classList.add("overlay"),document.querySelector(".modal-overlay").classList.remove("dp-none"),document.querySelector(".loan-form-heading-parent").style.display="block",document.querySelector(".loan-form-otp").style.display="block",document.querySelector(".loan-form-button-container").style.display="block",document.querySelector("#loan-form-otpnum").textContent=document.querySelector(".input-field input").value,v(q,g);const e=document.querySelector(".applyloanform .timer");e&&(e.style.display="block"),document.querySelector("#loan-form-otp-input").value="",document.querySelector("#otp-digits .changeableDigit").textContent="0"}function p(){document.querySelector(".pageloader").classList.contains("loader-disppear")&&document.querySelector(".pageloader").classList.remove("loader-disppear"),document.querySelector(".pageloader").style.display="block",document.querySelector(".loan-form-otp-button-container").classList.add("filterBlur"),document.querySelector(".loan-form.loan-form-sub-otp").classList.add("filterBlur")}function j(e){const o={headerJson:{"x-apikey":"7uPoKD0zsO527QGZ6oLI9SktlpEDwhsI","Content-Type":"remove"}};return new Promise((t,r)=>{const s=`https://apisit.piramal.com/customer-orchestrator/v1/partner/campaign/+91${e}/event-based-triggered`;y("POST",s,o).then(c=>{t(c.responseJson)})})}export function getWhatAPIAuth(){const e={requestJson:{}};return new Promise((o,t)=>{y("POST",I,e).then(r=>{o(r.responseJson)}).catch(r=>{i(r)})})}export function getWhatAPI(e,o){const t={requestJson:{authorization:e,campaign_id:"87",whatsapp_bsp:"6",client_data:{phone_number:`+91${o}`,name:"Name"}}};return new Promise((r,s)=>{y("POST",C,t).then(c=>{r(c.responseJson)}).catch(c=>{i(c)})})}export function sucessPopupCloe(){document.querySelector(".successContainer").style.display="none",close()}function b(e){e&&L(e).then(o=>{o.returnResponse.statusCode==100?(document.querySelector(".wrongotpmessage").style.display="none",document.querySelector(".wrongotpmessage").textContent="",getWhatAPIAuth().then(({status:t,auth_token:r})=>{t==200&&getWhatAPI(r,a).then(s=>{document.querySelector(".successContainer").style.display="block",document.querySelector(".loan-form-heading-parent").style.display="none",document.querySelector(".loan-form-otp").style.display="none",document.querySelector(".loan-form-button-container").style.display="none",document.querySelector(".mobileNumber").innerText=a,removeLoader()})}).catch(t=>{console.log(t)})):(document.querySelector(".wrongotpmessage").textContent=o.returnResponse.message,document.querySelector(".wrongotpmessage").style.display="block",document.querySelector(".loan-form-otp").style.display="block",document.querySelector(".loan-form-button-container").style.display="block",document.querySelector(".failedContainer").style.display="none",removeLoader())}).catch(o=>{i(o)})}
